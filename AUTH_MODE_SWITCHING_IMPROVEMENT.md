# è®¤è¯æ¨¡å¼åˆ‡æ¢å’Œä¼šè¯ç®¡ç†æ”¹è¿›

## æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°è§£å†³äº†ç™»å½•ä¼šè¯å®¹æ˜“å¤±æ•ˆçš„é—®é¢˜ï¼Œå¹¶æ·»åŠ äº†è®¤è¯æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥åœ¨HTTPæ¨¡å¼å’ŒSDKæ¨¡å¼ä¹‹é—´è‡ªç”±é€‰æ‹©ã€‚

## ä¸»è¦æ”¹è¿›

### 1. è®¤è¯æ¨¡å¼åˆ‡æ¢åŠŸèƒ½

- **ç™»å½•é¡µé¢å¢žåŠ æ¨¡å¼é€‰æ‹©å™¨**ï¼šç”¨æˆ·å¯ä»¥åœ¨ç™»å½•æ—¶é€‰æ‹©ä½¿ç”¨SDKæ¨¡å¼æˆ–HTTPæ¨¡å¼
- **åŠ¨æ€æ¨¡å¼åˆ‡æ¢**ï¼šæ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢è®¤è¯æ¨¡å¼ï¼Œæ— éœ€é‡å¯åº”ç”¨
- **ç”¨æˆ·åå¥½ä¿å­˜**ï¼šç³»ç»Ÿä¼šè®°ä½ç”¨æˆ·é€‰æ‹©çš„è®¤è¯æ¨¡å¼

### 2. ä¼šè¯ç®¡ç†ä¼˜åŒ–

#### SDKæ¨¡å¼ï¼ˆæŽ¨èï¼‰
- âœ… è‡ªåŠ¨ç®¡ç†ä¼šè¯çŠ¶æ€
- âœ… è‡ªåŠ¨åˆ·æ–°token
- âœ… æ›´ç¨³å®šçš„ç™»å½•çŠ¶æ€
- âœ… ä¸æ˜“å¤±æ•ˆ

#### HTTPæ¨¡å¼
- âš ï¸ æ‰‹åŠ¨ç®¡ç†ä¼šè¯
- ðŸ”„ è‡ªåŠ¨æ£€æµ‹tokenè¿‡æœŸ
- ðŸ”„ å®šæ—¶åˆ·æ–°æœºåˆ¶ï¼ˆæ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
- ðŸ”„ æ”¯æŒæ‰‹åŠ¨åˆ·æ–°token

### 3. è®¤è¯çŠ¶æ€ç›‘æŽ§

- **å®žæ—¶çŠ¶æ€æ˜¾ç¤º**ï¼šæ˜¾ç¤ºå½“å‰è®¤è¯æ¨¡å¼ã€ç™»å½•çŠ¶æ€ã€tokençŠ¶æ€
- **è¿‡æœŸæ—¶é—´æé†’**ï¼šæ˜¾ç¤ºtokenå‰©ä½™æœ‰æ•ˆæ—¶é—´
- **æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®**ï¼šHTTPæ¨¡å¼ä¸‹å¯æ‰‹åŠ¨åˆ·æ–°token
- **å¼€å‘æ¨¡å¼è‡ªåŠ¨æ˜¾ç¤º**ï¼šå¼€å‘çŽ¯å¢ƒä¸‹è‡ªåŠ¨æ˜¾ç¤ºç›‘æŽ§å™¨

### 4. æµ‹è¯•é¡µé¢

æ–°å¢ž `/auth-test` é¡µé¢ï¼Œæä¾›ï¼š
- è®¤è¯çŠ¶æ€æŸ¥çœ‹
- æ¨¡å¼åˆ‡æ¢æµ‹è¯•
- tokenä¿¡æ¯æŸ¥çœ‹
- å„ç§è®¤è¯æ“ä½œæµ‹è¯•

## ä½¿ç”¨æ–¹æ³•

### 1. ç™»å½•æ—¶é€‰æ‹©æ¨¡å¼

è®¿é—®ç™»å½•é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°è®¤è¯æ¨¡å¼é€‰æ‹©å™¨ï¼š
- **SDKæ¨¡å¼**ï¼šæŽ¨èé€‰æ‹©ï¼Œè‡ªåŠ¨ç®¡ç†ä¼šè¯ï¼Œæ›´ç¨³å®š
- **HTTPæ¨¡å¼**ï¼šæ‰‹åŠ¨ç®¡ç†ä¼šè¯ï¼Œå¯èƒ½ä¼šå¤±æ•ˆ

### 2. æŸ¥çœ‹è®¤è¯çŠ¶æ€

- **å¼€å‘æ¨¡å¼**ï¼šå³ä¸‹è§’è‡ªåŠ¨æ˜¾ç¤ºè®¤è¯çŠ¶æ€ç›‘æŽ§å™¨
- **ç”Ÿäº§æ¨¡å¼**ï¼šè®¿é—® `/auth-test` é¡µé¢æŸ¥çœ‹è¯¦ç»†çŠ¶æ€

### 3. åˆ‡æ¢è®¤è¯æ¨¡å¼

1. è®¿é—® `/auth-test` é¡µé¢
2. é€‰æ‹©æ–°çš„è®¤è¯æ¨¡å¼
3. ç‚¹å‡»"åˆ‡æ¢æ¨¡å¼"æŒ‰é’®
4. é‡æ–°ç™»å½•ä»¥ä½¿æ–°æ¨¡å¼ç”Ÿæ•ˆ

### 4. æ‰‹åŠ¨åˆ·æ–°tokenï¼ˆHTTPæ¨¡å¼ï¼‰

- åœ¨è®¤è¯ç›‘æŽ§å™¨ä¸­ç‚¹å‡»"æ‰‹åŠ¨åˆ·æ–°Token"æŒ‰é’®
- æˆ–åœ¨æµ‹è¯•é¡µé¢ä¸­ç‚¹å‡»"æ‰‹åŠ¨åˆ·æ–°Token"æŒ‰é’®

## æŠ€æœ¯å®žçŽ°

### 1. åŠ¨æ€è®¤è¯æ¨¡å¼

```typescript
const getAuthMode = () => {
  // ä¼˜å…ˆä½¿ç”¨ä¸´æ—¶è®¾ç½®çš„æ¨¡å¼ï¼ˆç”¨äºŽç™»å½•é¡µé¢åˆ‡æ¢ï¼‰
  if ((window as any).__TEMP_AUTH_MODE__) {
    return (window as any).__TEMP_AUTH_MODE__
  }
  
  // å…¶æ¬¡ä½¿ç”¨ç”¨æˆ·åå¥½è®¾ç½®
  const preferredMode = localStorage.getItem('preferred_auth_mode')
  if (preferredMode && ['http', 'sdk'].includes(preferredMode)) {
    return preferredMode
  }
  
  // æœ€åŽä½¿ç”¨çŽ¯å¢ƒå˜é‡é»˜è®¤å€¼
  return import.meta.env.VITE_AUTH_MODE || 'sdk'
}
```

### 2. è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

```typescript
const setupAutoRefresh = () => {
  const currentAuthMode = getAuthMode()
  if (currentAuthMode === 'http') {
    // HTTPæ¨¡å¼ä¸‹ï¼Œæ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡tokenæ˜¯å¦éœ€è¦åˆ·æ–°
    refreshTimer = setInterval(async () => {
      const token = localStorage.getItem('token')
      if (token && isTokenExpired(token)) {
        console.log('ðŸ”„ å®šæ—¶æ£€æŸ¥å‘çŽ°tokenè¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°...')
        await refreshToken()
      }
    }, 30 * 60 * 1000) // 30åˆ†é’Ÿ
  }
}
```

### 3. Tokenè¿‡æœŸæ£€æµ‹

```typescript
const isTokenExpired = (token: string) => {
  try {
    const payload = JSON.parse(atob(token.split('.')[1]))
    const currentTime = Math.floor(Date.now() / 1000)
    return payload.exp && payload.exp < currentTime
  } catch (error) {
    return true // å¦‚æžœæ— æ³•è§£æžï¼Œè®¤ä¸ºå·²è¿‡æœŸ
  }
}
```

## é…ç½®è¯´æ˜Ž

### çŽ¯å¢ƒå˜é‡

```env
# é»˜è®¤è®¤è¯æ¨¡å¼æ”¹ä¸ºSDKæ¨¡å¼ï¼ˆæ›´ç¨³å®šï¼‰
VITE_AUTH_MODE=sdk
```

### ç”¨æˆ·åå¥½

- `preferred_auth_mode`: ç”¨æˆ·é€‰æ‹©çš„è®¤è¯æ¨¡å¼
- `show_auth_monitor`: æ˜¯å¦æ˜¾ç¤ºè®¤è¯ç›‘æŽ§å™¨

## é—®é¢˜è§£å†³

### 1. ä¼šè¯å¤±æ•ˆé—®é¢˜

**åŽŸå› **ï¼šHTTPæ¨¡å¼ä¸‹tokenè¿‡æœŸåŽæ²¡æœ‰è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æŽ¨èä½¿ç”¨SDKæ¨¡å¼ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰
- HTTPæ¨¡å¼ä¸‹æ·»åŠ è‡ªåŠ¨æ£€æµ‹å’Œåˆ·æ–°æœºåˆ¶
- æä¾›æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½

### 2. ç”¨æˆ·ä½“éªŒé—®é¢˜

**åŽŸå› **ï¼šç”¨æˆ·ä¸çŸ¥é“å½“å‰è®¤è¯çŠ¶æ€å’Œå‰©ä½™æ—¶é—´

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ è®¤è¯çŠ¶æ€ç›‘æŽ§å™¨
- æ˜¾ç¤ºtokenè¿‡æœŸæ—¶é—´
- æä¾›å®žæ—¶çŠ¶æ€æ›´æ–°

## å»ºè®®

1. **æŽ¨èä½¿ç”¨SDKæ¨¡å¼**ï¼šæ›´ç¨³å®šï¼Œè‡ªåŠ¨ç®¡ç†ä¼šè¯
2. **å¼€å‘æ—¶å¯ç”¨ç›‘æŽ§å™¨**ï¼šä¾¿äºŽè°ƒè¯•è®¤è¯é—®é¢˜
3. **å®šæœŸæ£€æŸ¥è®¤è¯çŠ¶æ€**ï¼šç‰¹åˆ«æ˜¯é•¿æ—¶é—´ä½¿ç”¨çš„æƒ…å†µ
4. **é‡åˆ°é—®é¢˜æ—¶åˆ‡æ¢æ¨¡å¼**ï¼šå¦‚æžœä¸€ç§æ¨¡å¼æœ‰é—®é¢˜ï¼Œå¯ä»¥å°è¯•å¦ä¸€ç§

## æµ‹è¯•æ­¥éª¤

1. è®¿é—® `/login` é¡µé¢ï¼Œæµ‹è¯•æ¨¡å¼é€‰æ‹©åŠŸèƒ½
2. ä½¿ç”¨ä¸åŒæ¨¡å¼ç™»å½•ï¼Œè§‚å¯Ÿä¼šè¯ç¨³å®šæ€§
3. è®¿é—® `/auth-test` é¡µé¢ï¼Œæµ‹è¯•å„ç§åŠŸèƒ½
4. é•¿æ—¶é—´ä½¿ç”¨ï¼Œè§‚å¯Ÿtokenè‡ªåŠ¨åˆ·æ–°æƒ…å†µ
5. æ‰‹åŠ¨åˆ·æ–°tokenï¼ŒéªŒè¯åŠŸèƒ½æ­£å¸¸

## æ³¨æ„äº‹é¡¹

- åˆ‡æ¢è®¤è¯æ¨¡å¼åŽéœ€è¦é‡æ–°ç™»å½•
- HTTPæ¨¡å¼ä¸‹éœ€è¦ç¡®ä¿æœ‰refresh_token
- å¼€å‘æ¨¡å¼ä¸‹ä¼šè‡ªåŠ¨æ˜¾ç¤ºç›‘æŽ§å™¨
- ç”Ÿäº§çŽ¯å¢ƒå»ºè®®ä½¿ç”¨SDKæ¨¡å¼